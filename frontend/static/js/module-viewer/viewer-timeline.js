ModuleCoach.prototype.initTimeline=function(){const duration=this.videoDuration;if(!duration)return;this.timelineTrack.innerHTML='';const seg=document.createElement('div');seg.className='viewer-timeline-segment active';seg.style.flex='none';seg.style.width='100%';const fill=document.createElement('div');fill.className='viewer-timeline-segment-fill';seg.appendChild(fill);this.timelineTrack.appendChild(seg);this.timelineLabels.innerHTML='';const breakdown=this.currentSection.breakdown||[];breakdown.forEach((item,i)=>{const posPercent=duration>0?(item.time/duration)*100:0;const label=document.createElement('div');label.className='viewer-timeline-label'+(i===0?' active':'');label.dataset.breakdownIndex=i;label.style.left=posPercent+'%';label.innerHTML='<span class="viewer-tl-text">'+item.label+'</span>';label.addEventListener('click',()=>{if(this.videoEl.duration&&!isNaN(this.videoEl.duration)){this.videoEl.currentTime=Math.min(item.time,this.videoEl.duration);this.playVideo();}});this.timelineLabels.appendChild(label);const marker=document.createElement('div');marker.className='viewer-timeline-marker';marker.style.left=posPercent+'%';this.timelineTrack.appendChild(marker);});this.initTimelineDrag();this.initTimelinePreview();};ModuleCoach.prototype.initTimelineDrag=function(){this.isDragging=false;this.wasPlayingBeforeDrag=false;const getRatioFromEvent=(e)=>{const rect=this.timelineTrack.getBoundingClientRect();const clientX=e.touches?e.touches[0].clientX:e.clientX;return Math.max(0,Math.min(1,(clientX-rect.left)/rect.width));};const startDrag=(e)=>{if(!this.videoEl.duration||isNaN(this.videoEl.duration))return;const trackRect=this.timelineTrack.getBoundingClientRect();const clientY=e.touches?e.touches[0].clientY:e.clientY;const hitPadding=trackRect.height*3;if(clientY<trackRect.top-hitPadding||clientY>trackRect.bottom+hitPadding)return;e.preventDefault();this.isDragging=true;this.wasPlayingBeforeDrag=!this.videoEl.paused;this._userPaused=true;this.videoEl.pause();this.timelinePlayhead.classList.add('dragging');const ratio=getRatioFromEvent(e);this.videoEl.currentTime=ratio*this.videoEl.duration;this.updatePlayheadVisual(ratio);};const moveDrag=(e)=>{if(!this.isDragging)return;e.preventDefault();const ratio=getRatioFromEvent(e);this.videoEl.currentTime=ratio*this.videoEl.duration;this.updatePlayheadVisual(ratio);this.updatePreviewAtRatio(ratio);};const endDrag=()=>{if(!this.isDragging)return;this.isDragging=false;this.timelinePlayhead.classList.remove('dragging');if(this.wasPlayingBeforeDrag){this.playVideo();}
this.hidePreview();};var self=this;var startDragWrap=function(e){startDrag(e);if(self.isDragging){document.addEventListener('mousemove',moveDrag);document.addEventListener('mouseup',endDragWrap);document.addEventListener('touchmove',moveDrag,{passive:false});document.addEventListener('touchend',endDragWrap);}};var endDragWrap=function(){endDrag();document.removeEventListener('mousemove',moveDrag);document.removeEventListener('mouseup',endDragWrap);document.removeEventListener('touchmove',moveDrag);document.removeEventListener('touchend',endDragWrap);};this.timelineBar.addEventListener('mousedown',startDragWrap);this.timelineBar.addEventListener('touchstart',startDragWrap,{passive:false});};ModuleCoach.prototype.updatePlayheadVisual=function(ratio){const pct=ratio*100;this.timelinePlayhead.style.left=pct+'%';this.currentTimeEl.textContent=this.formatTime(ratio*this.videoEl.duration);const seg=this.timelineTrack.querySelector('.viewer-timeline-segment');if(seg){const fill=seg.querySelector('.viewer-timeline-segment-fill');if(fill)fill.style.width=Math.min(pct,100)+'%';}};ModuleCoach.prototype.initTimelinePreview=function(){this.previewEl=document.getElementById('timeline-preview');this.previewCanvas=document.getElementById('timeline-preview-canvas');this.previewCtx=this.previewCanvas.getContext('2d');this.previewTimeEl=document.getElementById('timeline-preview-time');this.previewVideo=document.getElementById('viewer-preview-video');this.previewPending=false;this.previewLoaded=false;if(this.previewVideo.readyState<1){this.previewVideo.addEventListener('loadedmetadata',()=>{this.previewReady=true;});}else{this.previewReady=true;this.previewLoaded=true;}
this.previewVideo.addEventListener('seeked',()=>{this.previewCtx.drawImage(this.previewVideo,0,0,160,90);this.previewPending=false;});this.timelineBar.addEventListener('mousemove',(e)=>{if(this.isDragging)return;const trackRect=this.timelineTrack.getBoundingClientRect();const clientY=e.clientY;const hitPadding=trackRect.height*3;if(clientY<trackRect.top-hitPadding||clientY>trackRect.bottom+hitPadding){this.hidePreview();return;}
const ratio=Math.max(0,Math.min(1,(e.clientX-trackRect.left)/trackRect.width));this.updatePreviewAtRatio(ratio);this.showPreview(ratio);});this.timelineBar.addEventListener('mouseleave',()=>{if(!this.isDragging){this.hidePreview();}});};ModuleCoach.prototype.updatePreviewAtRatio=function(ratio){if(!this.previewLoaded&&this.previewVideo){this.previewLoaded=true;this.previewVideo.load();}
if(!this.previewReady||!this.previewVideo)return;const time=ratio*this.videoEl.duration;this.previewTimeEl.textContent=this.formatTime(time);if(!this.previewPending){this.previewPending=true;this.previewVideo.currentTime=time;}
this.showPreview(ratio);};ModuleCoach.prototype.showPreview=function(ratio){if(!this.previewEl)return;this.previewEl.classList.add('visible');this.previewEl.style.left=(ratio*100)+'%';};ModuleCoach.prototype.hidePreview=function(){if(!this.previewEl)return;this.previewEl.classList.remove('visible');};ModuleCoach.prototype.updateTimelineProgress=function(){if(this.isDragging)return;const video=this.videoEl;if(!video.duration||isNaN(video.duration))return;const currentTime=video.currentTime;const duration=video.duration;this.currentTimeEl.textContent=this.formatTime(currentTime);this.totalTimeEl.textContent=this.formatTime(duration);const progress=currentTime/duration;const seg=this.timelineTrack.querySelector('.viewer-timeline-segment');if(seg){const fill=seg.querySelector('.viewer-timeline-segment-fill');if(fill)fill.style.width=Math.min(progress*100,100)+'%';}
this.timelinePlayhead.style.left=(progress*100)+'%';this.updateActiveBreakdown(currentTime);};ModuleCoach.prototype.updateActiveBreakdown=function(currentTime){if(!this.breakdownTimes.length)return;let activeIdx=0;for(let i=this.breakdownTimes.length-1;i>=0;i--){if(currentTime>=this.breakdownTimes[i]){activeIdx=i;break;}}
const timelineLabels=this.timelineLabels.querySelectorAll('.viewer-timeline-label');timelineLabels.forEach((label,i)=>{label.classList.toggle('active',i===activeIdx);});this.sectionsListEl.querySelectorAll('.viewer-section-item').forEach((item,i)=>{item.classList.toggle('active',i===activeIdx);});};ModuleCoach.prototype.formatTime=function(seconds){if(isNaN(seconds)||seconds<0)return'0:00';const mins=Math.floor(seconds/60);const secs=Math.floor(seconds%60);return mins+':'+(secs<10?'0':'')+secs;};ModuleCoach.prototype.handleTimelineClick=function(e){if(this.isDragging)return;const rect=this.timelineTrack.getBoundingClientRect();const hitPadding=rect.height*3;if(e.clientY<rect.top-hitPadding||e.clientY>rect.bottom+hitPadding)return;const clickX=e.clientX-rect.left;const trackWidth=rect.width;const clickRatio=Math.max(0,Math.min(1,clickX/trackWidth));if(this.videoEl.duration&&!isNaN(this.videoEl.duration)){this.videoEl.currentTime=clickRatio*this.videoEl.duration;}};